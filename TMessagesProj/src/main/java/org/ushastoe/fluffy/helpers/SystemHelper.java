package org.ushastoe.fluffy.helpers;

import android.app.Activity;
import android.content.SharedPreferences;
import android.content.res.Configuration;
import org.telegram.messenger.ApplicationLoader;
import org.telegram.messenger.NotificationCenter;
import org.telegram.ui.ActionBar.Theme;

public class SystemHelper {
  public static void checkTheme() {
    SharedPreferences preferences =
        ApplicationLoader.applicationContext.getSharedPreferences(
            "themeconfig", Activity.MODE_PRIVATE);

    String dayThemeName = preferences.getString("lastDayTheme", "Blue");
    if (Theme.getTheme(dayThemeName) == null ||
        Theme.getTheme(dayThemeName).isDark()) {
      dayThemeName = "Blue";
    }

    String nightThemeName = preferences.getString("lastDarkTheme", "Dark Blue");
    if (Theme.getTheme(nightThemeName) == null ||
        !Theme.getTheme(nightThemeName).isDark()) {
      nightThemeName = "Dark Blue";
    }
    Theme.ThemeInfo themeInfo = Theme.getActiveTheme();
    if (dayThemeName.equals(nightThemeName)) {
      if (themeInfo.isDark() || dayThemeName.equals("Dark Blue") ||
          dayThemeName.equals("Night")) {
        dayThemeName = "Blue";
      } else {
        nightThemeName = "Dark Blue";
      }
    }
    boolean currentThemeDark = Theme.isCurrentThemeDark();
    int currentNightMode = ApplicationLoader.applicationContext.getResources()
                               .getConfiguration()
                               .uiMode &
                           Configuration.UI_MODE_NIGHT_MASK;
    boolean darkSystem = switch (currentNightMode) {
      case Configuration.UI_MODE_NIGHT_YES -> true;
      default -> false;
    };
    if (darkSystem == currentThemeDark) {
      return;
    } else if (darkSystem) {
      themeInfo = Theme.getTheme(nightThemeName);
    } else {
      themeInfo = Theme.getTheme(dayThemeName);
    }
    NotificationCenter.getGlobalInstance().postNotificationName(
        NotificationCenter.needSetDayNightTheme, themeInfo, false, null, -1);
  }
}
